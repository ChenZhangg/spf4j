<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/markdown/index.md at 2018-11-30
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20181130" />
    <meta http-equiv="Content-Language" content="en" />
    <title>spf4j &#x2013; Spf4j (Simple performance framework for java)</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script type="text/javascript" src="./js/apache-maven-fluido-1.7.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>SPF4J</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-11-30<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 8.5.26-SNAPSHOT</li>
      <li class="pull-right"><a href="./" title="SPF4J">SPF4J</a></li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Main Menu</li>
    <li class="active"><a href="#"><span class="none"></span>Introduction</a></li>
    <li><a href="http://search.maven.org/#search|ga|1|spf4j" class="externalLink" title="Download"><span class="none"></span>Download</a></li>
      <li class="nav-header">Modules</li>
    <li><a href="spf4j-aether/index.html" title="spf4j-aether"><span class="none"></span>spf4j-aether</a></li>
    <li><a href="spf4j-asm/index.html" title="spf4j-asm"><span class="none"></span>spf4j-asm</a></li>
    <li><a href="spf4j-config-discovery-maven-plugin/index.html" title="spf4j-config-discovery-maven-plugin"><span class="none"></span>spf4j-config-discovery-maven-plugin</a></li>
    <li><a href="spf4j-jdiff-maven-plugin/index.html" title="spf4j-jdiff-maven-plugin"><span class="none"></span>spf4j-jdiff-maven-plugin</a></li>
    <li><a href="spf4j-core/index.html" title="spf4j-core"><span class="none"></span>spf4j-core</a></li>
    <li><a href="spf4j-slf4j-test/index.html" title="spf4j-slf4j-test"><span class="none"></span>spf4j-slf4j-test</a></li>
    <li><a href="spf4j-joda/index.html" title="spf4j-joda"><span class="none"></span>spf4j-joda</a></li>
    <li><a href="spf4j-core-gwt/index.html" title="spf4j-core-gwt"><span class="none"></span>spf4j-core-gwt</a></li>
    <li><a href="spf4j-junit/index.html" title="spf4j-junit"><span class="none"></span>spf4j-junit</a></li>
    <li><a href="spf4j-jmh/index.html" title="spf4j-jmh"><span class="none"></span>spf4j-jmh</a></li>
    <li><a href="spf4j-ui/index.html" title="spf4j-ui"><span class="none"></span>spf4j-ui</a></li>
    <li><a href="spf4j-aspects/index.html" title="spf4j-aspects"><span class="none"></span>spf4j-aspects</a></li>
    <li><a href="spf4j-zel/index.html" title="spf4j-zel"><span class="none"></span>spf4j-zel</a></li>
    <li><a href="spf4j-avro-components/index.html" title="spf4j-avro-components"><span class="none"></span>spf4j-avro-components</a></li>
    <li><a href="spf4j-jacoco-aggregate/index.html" title="spf4j-jacoco-aggregate"><span class="none"></span>spf4j-jacoco-aggregate</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-down"></span>Project Information</a>
    <ul class="nav nav-list">
    <li><a href="integration.html" title="Continuous Integration"><span class="none"></span>Continuous Integration</a></li>
    <li><a href="dependencies.html" title="Dependencies"><span class="none"></span>Dependencies</a></li>
    <li><a href="dependency-convergence.html" title="Dependency Convergence"><span class="none"></span>Dependency Convergence</a></li>
    <li><a href="dependency-info.html" title="Dependency Information"><span class="none"></span>Dependency Information</a></li>
    <li><a href="distribution-management.html" title="Distribution Management"><span class="none"></span>Distribution Management</a></li>
    <li class="active"><a href="#"><span class="none"></span>About</a></li>
    <li><a href="issue-tracking.html" title="Issue Tracking"><span class="none"></span>Issue Tracking</a></li>
    <li><a href="license.html" title="Project License"><span class="none"></span>Project License</a></li>
    <li><a href="mail-lists.html" title="Mailing Lists"><span class="none"></span>Mailing Lists</a></li>
    <li><a href="modules.html" title="Project Modules"><span class="none"></span>Project Modules</a></li>
    <li><a href="plugin-management.html" title="Plugin Management"><span class="none"></span>Plugin Management</a></li>
    <li><a href="plugins.html" title="Project Plugins"><span class="none"></span>Project Plugins</a></li>
    <li><a href="team-list.html" title="Project Team"><span class="none"></span>Project Team</a></li>
    <li><a href="source-repository.html" title="Source Repository"><span class="none"></span>Source Repository</a></li>
    <li><a href="project-summary.html" title="Project Summary"><span class="none"></span>Project Summary</a></li>
    </ul>
</li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>Spf4j (Simple performance framework for java)</h1>
<div class="section">
<h2><a name="a1._Overview"></a>1. Overview</h2>
<p>The spf4j library is a collection of utilities and components to monitor, troubleshoot and fix performance issues. This library also contains useful general purpose utilities and components that are currently not available in high quality form in other OS libraries (Retry utils, object pool, <a class="externalLink" href="http://www.spf4j.org/spf4j-slf4j-test/index.html">test logging backend</a> &#x2026;) This library also contains ZEL, a simple expression language that can be easily used in any java application. Zel is easy to extend to your needs and also has some cool features like async functions, memorization&#x2026; You can learn more by checking out the <a class="externalLink" href="http://www.spf4j.org/spf4j-zel/index.html">spf4j-zel</a> module.</p></div>
<div class="section">
<h2><a name="a2._License_and_Contributions"></a>2. License and Contributions</h2>
<p>This library is <a class="externalLink" href="http://www.gnu.org/licenses/lgpl.html">LGPL</a> and <a class="externalLink" href="http://www.apache.org/licenses/LICENSE-2.0.txt">Apache 2.0</a> licensed.</p>
<p>Contributions/Contributors to spf4j are welcome.</p></div>
<div class="section">
<h2><a name="a3._Code.2C_Binaries.2C_Build"></a>3. Code, Binaries, Build</h2>
<p><a class="externalLink" href="https://github.com/zolyfarkas/spf4j/">SPF4J Github hosted repo</a></p>
<p>Available on <a class="externalLink" href="https://maven-badges.herokuapp.com/maven-central/org.spf4j/spf4j-core/"><img src="https://maven-badges.herokuapp.com/maven-central/org.spf4j/spf4j-core/badge.svg" alt="Maven Central" /></a></p>
<p>More info can be found on the [blog] (<a class="externalLink" href="https://blogs.zoltran.com">https://blogs.zoltran.com</a>)</p>
<p><a class="externalLink" href="https://gitter.im/spf4j/Lobby"><img src="https://badges.gitter.im/zolyfarkas/spf4j.png" alt="Gitter chat" /></a></p>
<p><a class="externalLink" href="https://scan.coverity.com/projects/3158"><img src="https://scan.coverity.com/projects/3158/badge.svg" alt="Coverity Badge" /></a></p>
<p><a class="externalLink" href="https://sonarcloud.io/dashboard?id=org.spf4j%3Aspf4j"><img src="https://sonarcloud.io/api/project_badges/measure?project=org.spf4j%3Aspf4j&amp;metric=alert_status" alt="Quality Gate" /></a></p>
<p><a class="externalLink" href="https://www.codacy.com/app/zolyfarkas/spf4j?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=zolyfarkas/spf4j&amp;utm_campaign=Badge_Grade"><img src="https://api.codacy.com/project/badge/Grade/48b50176945242729f4386b05be8c8dc" alt="Codacy Badge" /></a></p>
<p><a class="externalLink" href="https://travis-ci.org/zolyfarkas/spf4j"><img src="https://travis-ci.org/zolyfarkas/spf4j.svg?branch=master" alt="CI badge" /></a></p></div>
<div class="section">
<h2><a name="a4._Performance_monitoring"></a>4. Performance monitoring</h2>
<div class="section">
<h3><a name="a4.1._Why_not_use_jamon.2C_metrics.2C_netflix_servo_.3F"></a>4.1. Why not use jamon, metrics, netflix servo ?</h3>
<p>Observing a system changes the system. The goal of this library is to minimize the observer effect. The code in spf4j is carefully written to be as high performance as possible, it should outperform all competing libraries on any modern JVM(implementing biased locking) running on a CCNUMA system.</p>
<p>To achieve the lowest overhead we utilize Thread Local Counters, for a good evaluation see: <a class="externalLink" href="http://psy-lob-saw.blogspot.com/2013/06/java-concurrent-counters-by-numbers.html">Concurrent counters by numbers</a></p></div>
<div class="section">
<h3><a name="a4.2._How_to_record_measurements.3F"></a>4.2. How to record measurements?</h3>
<div class="section">
<h4><a name="a4.2.1_Via_API"></a>4.2.1 Via API</h4>
<ul>

<li>Low impact with log linear quantized recording for Gauge type of measurements:</li>
</ul>

<div>
<div>
<pre class="source">private static final MeasurementRecorder recorder 
                     = RecorderFactory.createScalableQuantizedRecorder(forWhat, unitOfMeasurement,
                     sampleTime, factor, lowerMagnitude, higherMagnitude, quantasPerMagnitude);
&#x2026;
recorder.record(measurement);
</pre></div></div>

<p>This is ideal for recording execution times and provides the most detail. (Min, max, avg, and detailed distribution heat chart) If distribution chart is not needed createScalableMinMaxAvgRecorder is available with less overhead.</p>
<ul>

<li>Low impact with simple counting for Counters.</li>
</ul>

<div>
<div>
<pre class="source">private static final MeasurementRecorder recorder 
                     = RecorderFactory.createScalableCountingRecorder(forWhat, unitOfMeasurement, sampleTimeMillis);
&#x2026;
recorder.record(measurement);
</pre></div></div>

<div>
<div>
<pre class="source">This is ideal for measurements like bytesSent, bytesReceived.
</pre></div></div>

<ul>

<li>Dynamic with log linear quantized recording for Gauge type of measurements.</li>
</ul>

<div>
<div>
<pre class="source">private static final MeasurementRecorderSource recorderSource
                    = RecorderFactory.createScalableQuantizedRecorderSource( forWhatCategory, unitOfMeasurement,
                      sampleTime, factor, lowerMagnitude, higherMagnitude, quantasPerMagnitude);
&#x2026;
recorderSource.getRecorder(forWhat).record(measurement)
</pre></div></div>

<div>
<div>
<pre class="source">As with the low impact static recorders there are dynamic equivalents:
createScalableMinMaxAvgRecorderSource and createScalableCountingRecorderSource
</pre></div></div>

<p>You can also create a monitored callable and call it of pass it to a executor like :</p>

<div>
<div>
<pre class="source">Callable&lt;?&gt; monitoredCallable = 
     performanceMonitoredCallable(recorderSource, warnMillis, errorMillis, callable, &quot;myCallable&quot;).call()
</pre></div></div>
</div>
<div class="section">
<h4><a name="a4.2.2_Via_Annotations"></a>4.2.2 Via Annotations</h4>
<p>Annotate a method you want to measure and monitor performance with the annotation:</p>

<div>
<div>
<pre class="source">@PerformanceMonitor(warnThresholdMillis=1, errorThresholdMillis=100, recorderSource = RecorderSourceInstance.Rs5m.class)
</pre></div></div>

<p>Start your jvm with Aspectj(1.7.x if you use java 1.7 or 1.8.x if you use java 1.8) load time weaver:</p>

<div>
<div>
<pre class="source">-javaagent:${project.build.directory}/lib/aspectjweaver-${aspectj.version}.jar
</pre></div></div>

<p>Make sure your aspectj config file (META-INF/aop.xml) contains:</p>

<div>
<div>
<pre class="source">&lt;aspectj&gt;
&lt;aspects&gt;
&lt;aspect name=&quot;org.spf4j.perf.aspects.PerformanceMonitorAspect&quot;/&gt;
&lt;/aspects&gt;
&lt;weaver options=&quot;-verbose&quot;&gt;
    &lt;!-- make sure the classes you want to apply aspects to are included --&gt;
    &lt;include within=&quot;com..*&quot;/&gt;
    &lt;include within=&quot;org.spf4j.perf.aspects.PerformanceMonitorAspect&quot;/&gt;
&lt;/weaver&gt;
&lt;/aspectj&gt;
</pre></div></div>

<p>This will record the execution times of the annotated method, and will also log (via spf4j) a message containing the call detail and execution time if the warn or error thresholds are exceeded. Dynamic quantized recorder source is used.</p></div>
<div class="section">
<h4><a name="a4.2.3_Where_are_measurements_stored.3F"></a>4.2.3 Where are measurements stored?</h4>
<p>You can configure where the measurements are stored via the &#x201c;spf4j.perf.ms.config&#x201d; system property like:</p>

<div>
<div>
<pre class="source">  -Dspf4j.perf.ms.config=TSDB@/path/to/file.tsdb,TSDB_TXT@/path/to/file.tsdbtxt,GRAPHITE_UDP@1.1.1.1:8080,GRAPHITE_TCP@1.1.1.1:8080
</pre></div></div>

<p>TSDB - binary file format (this is the most efficient store)</p>
<p>TSDB_TXT - text format each line: groupname, timestamp millis, sampletime millis, measurementName1, measurementValue2, &#x2026;</p>
<p>GRAPHITE_UDP - Graphite UDP appender.</p>
<p>GRAPHITE_TCP - Graphite UDP appender.</p></div></div>
<div class="section">
<h3><a name="a4.3._How_to_see_the_recorded_measurements.3F"></a>4.3. How to see the recorded measurements?</h3>
<ul>

<li>Via JMX</li>
</ul>
<p>invoke org.spf4j.perf.impl.ms.tsdb.TSDBMeasurementStore/flush to flush all measurements from memory to disk.</p>
<p>invoke org.spf4j.perf.impl.ms.tsdb.TSDBMeasurementStore/getTableAsCsv to get the data from a particular tsdb table as csv.</p>
<p>invoke org.spf4j.perf.impl.ms.tsdb.TSDBMeasurementStore/writeTableAsCsv to write the data from a particular rsdb table to a csv file.</p>
<ul>

<li>spf4j-UI.</li>
</ul>
<p>The recorded measurements are saved to a TSDB file. Use the library provided UI (spf4j-ui module) to open the file and visualize the measurements.</p>
<p><img src="images/explorer-ui.png" alt="Explorer UI" /></p>
<p><img src="images/spf4j_dist.png" alt="Distribution Chart" /></p></div>
<div class="section">
<h3><a name="a4.4._How_does_it_work_.3F"></a>4.4. How does it work ?</h3>
<p>Measurements are recorded and stored in the Thread local storage. At scheduled intervals the measurements aare retrieved, aggregated and stored to a TSDB file. Charts are generated using jfreechart library. TSDB file can also be opened and measurements viewed with the library embeded UI.</p>

<div>
<div>
<pre class="source">[Code context] ---record(value)---&gt; [Thread Local Storage] ----&gt; [Aggregator/Persister] -----&gt; [TSDB]

</pre></div></div>
</div>
<div class="section">
<h3><a name="a4.5_Export_any_object_attribute_or_operations_via_JMX"></a>4.5 Export any object attribute or operations via JMX</h3>
<p>You can annotate with @JmxExport getters and setters of a attribute or any other method that you want to make available via JMX. Here is what you need to do:</p>

<div>
<div>
<pre class="source">    public static final class JmxTest {
            
        private volatile String stringVal;

        @JmxExport
        public String getStringVal() {
            return stringVal;
        }

        @JmxExport
        public void setStringVal(final String stringVal) {
            this.stringVal = stringVal;
        }
        
        private static volatile String testStr;

        @JmxExport
        public static String getTestStr() {
            return testStr;
        }

        public static void setTestStr(final String testStr) {
            JmxTest2.testStr = testStr;
        }     
        
    }
...
        // Create object
        JmxTest testObj = new JmxTest();
        // Expose object via JMX (JmxExport annotated methods)
        Registry.export(&quot;test&quot;, &quot;Test&quot;, testObj);

 
</pre></div></div>
</div></div>
<div class="section">
<h2><a name="a5._Performance_Profiling"></a>5. Performance Profiling</h2>
<div class="section">
<h3><a name="a5.1._Why_another_profiling_library.3F"></a>5.1. Why another profiling library?</h3>
<p>It all started with Brendan Gregg&#x2019;s blog: <a class="externalLink" href="http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/">http://dtrace.org/blogs/brendan/2011/12/16/flame-graphs/</a> combined with a few hours of coding. However since than more monitoring capability has been added to spf4j. Flame-graph visualization has been improved to better see hot function calls&#x2026; Aspects to monitor object allocation, network, file, memory, garbage collection usage have been added. One of the main advantages of spf4j is that it can be easily be used for continuous profiling. The captured profile data is persisted to ssdump files which can be opened and visualized with the spf4j UI.</p>
<p>Due to the use of Thread.getStackTraces() the profile data is safe point biased, which is an important aspect to consider when analyzing your profile results. For more detail on safepoint bias see:</p>
<p><a class="externalLink" href="http://psy-lob-saw.blogspot.com/2016/02/why-most-sampling-java-profilers-are.html">Blog post on safepoint bias</a></p>
<p><a class="externalLink" href="http://sape.inf.usi.ch/publications/pldi10">Evaluating the accuracy of Java profilers</a></p>
<p>[Honest profiler](<a class="externalLink" href="https://www.youtube.com/watch?v=Yg6_ulhwLw0">https://www.youtube.com/watch?v=Yg6_ulhwLw0</a>, <a class="externalLink" href="https://github.com/RichardWarburton/honest-profiler">https://github.com/RichardWarburton/honest-profiler</a>)</p></div>
<div class="section">
<h3><a name="a5.2._When_to_profile_your_code.3F"></a>5.2. When to profile your code?</h3>
<p>I recommend to deploy your code with profiling turned on as much as you can. In my case I have profiling data collection turned on in test/qa environments all the time. (with 100ms sampling interval). If you can afford to do it in PROD do it. Another good time to profile your code is during your JMH (<a class="externalLink" href="http://openjdk.java.net/projects/code-tools/jmh/">http://openjdk.java.net/projects/code-tools/jmh/</a>) benchmarks. A good practice is to have a benchmark module in your project, that will benchmark key functionality of your application. These benchmarks will be run as part of your build process, and you can monitor the performance of your project with a Jenkins JMH <a class="externalLink" href="https://github.com/blackboard/jmh-jenkins">plugin</a> With spf4j-junit you can also easily profile your unit tests with Spf4jRunListener.</p></div>
<div class="section">
<h3><a name="a5.3._How_to_profile_your_code.3F"></a>5.3. How to profile your code?</h3>
<p>Add spf4j to your classpath and the following to your command line:</p>

<div>
<div>
<pre class="source">${JAVA_HOME}/bin/java [your jvm args] org.spf4j.stackmonitor.Monitor -df [folder to write date] -dp [file prefix] -ss -si 100  -main [your app main class] -- [your app arguments]
</pre></div></div>

<p>This will start your application with profiling enabled, with a 100 ms sampling interval. After the process ends ssdump file will ge generated containing the profiling data. Profiling can also be enabled/disabled via JMX.</p>
<p>Supported arguments:</p>

<div>
<div>
<pre class="source">Usage:
 -df VAL   : dump folder (default: ./target)
 -di N     : the stack dump to file interval in milliseconds (default: 3600000)
 -dp VAL   : dump file prefix (default: ManagementFactory.getRuntimeMXBean().getName())
 -main VAL : the main class name
 -si N     : the stack sampling interval in milliseconds (default: 100)
 -ss       : start the stack sampling thread. (can also be done manually via
             jmx) (default: false)
</pre></div></div>

<p>You can also run and control the profiler via its java API:</p>

<div>
<div>
<pre class="source">    Sampler SAMPLER = new Sampler(SAMPLE_PERIOD_MSEC);
    SAMPLER.start();
    SAMPLER.stop();
    SampleNode collected = SAMPLER.getStackCollector().clear();
    Converter.saveToFile(fileName, collected);

</pre></div></div>

<p>If you want to profile your JMH benchmarks you can simply add the spf4j JMH profiler to your startup options:</p>

<div>
<div>
<pre class="source">        Options opt = new OptionsBuilder()
                .include(&quot;.*&quot;)
                .addProfiler(JmhProfiler.class)
                .build();
         new Runner(opt).run();

</pre></div></div>

<p>The profiling measurements will be save to file into the current dir. They can be opened and analized with the spf4j-ui.</p>
<p>Spf4j contains also a JMH Profiler integration for Java Flight Recorder, to use it all you need to do is:</p>

<div>
<div>
<pre class="source">        Options opt = new OptionsBuilder()
                .include(&quot;.*&quot;)
                .addProfiler(JmhFlightRecorderProfiler.class)
                .build();
         new Runner(opt).run();

</pre></div></div>

<p>Java flight recorder should not have the safe point bias that spf4j has, however java flight recorder is a commercial feature that requires a license from Oracle for production use. For production use spf4j profiler is a zero cost alternative, which due to its simplicity should be a more reliable option as well.</p>
<p>THe Jmh integration is available in spf4j-jmh module:</p>

<div>
<div>
<pre class="source">        &lt;dependency&gt;
            &lt;groupId&gt;org.spf4j&lt;/groupId&gt;
            &lt;artifactId&gt;spf4j-jmh&lt;/artifactId&gt;
            &lt;version&gt;...&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
</pre></div></div>
</div>
<div class="section">
<h3><a name="a5.4._How_to_see_the_profile_data.3F"></a>5.4. How to see the profile data?</h3>
<p>After the program finishes it will write the data to the {{{./stackSample.html}stackSample.html}} file</p>
<p>If you have a server application running and you started it with stack sampling, by default every 1 hour the collected stack data is dumped to the temp folder. You can also invoke Sampler.dumpToFile to dum the stack samples at any time in your program allowing you to separate out samples at relevant times in your application. You can load and visualize this data with the library embeded ui:</p>
<p><img src="images/spf4j-flame-graph.png" alt="Flame Graph" /></p>
<p>The classic flame graph visualization remains available. The explorer ui can be used to visualize the measurements stored in the tsdb files. You can also export the measurements to csv format allowing you to analyze them with tools like excel.</p>
<p><img src="images/explorer-ui.png" alt="Explorer UI" /></p>
<p>in the UI you can filter certain stack traces by right clicking on them and using the filter option in the context menu.</p></div>
<div class="section">
<h3><a name="a5.5._How_does_it_work.3F"></a>5.5. How does it work?</h3>
<p>A sampling thread is started and running in the background. This thread uses Thread.getAllStackTraces() or the JVM MX beans (configurable) to get all stack traces for all threads. Each sample is added to a tree that aggregates the stack trace data.</p></div>
<div class="section">
<h3><a name="a5.6._Monitoring_memory_allocations:"></a>5.6. Monitoring memory allocations:</h3>
<p>You will need to apply aspect org.spf4j.memorymonitor.AllocationMonitorAspect to the code you want to monitor object allocations. This aspect will intercept all new objects calls in your code and it will use performance monitoring described at chapter 4 to record the number and amount of allocations. AspectJ load time weaving is not capable of intercepting allocations done inside rt.jar. You will have to apply your aspect against rt.jar and create a new one and add it to the boot class path in case you want to see all allocations.</p>
<p>Getting access to the data is same as described in chapter 4, you can do it over jmx, or opening the tsdb file in the embeded ui:</p>
<p><img src="images/spf4j_allocations.png" alt="allocations" /></p>
<p>Allocations are classified based on the class where they are done. This allows you to quickly identify memory hogs. In the chart above you can see how memory allocations happened, both byteSize and allocation count and what class. Object size computation might be too much overhead, in that case you can disable it by system property setting:</p>

<div>
<div>
<pre class="source">-Dperf.allocations.recordSize=false
</pre></div></div>
</div>
<div class="section">
<h3><a name="a5.7._Monitoring_Network_IO"></a>5.7. Monitoring Network IO</h3>
<p>The aspect org.spf4j.iomonitor.NetworkMonitorAspect will allow you to monitor you processes network traffic.</p>
<p><img src="images/spf4j_io.png" alt="network traffic" /> network traffic</p></div>
<div class="section">
<h3><a name="a5.8._Monitoring_Memory_Usage"></a>5.8. Monitoring Memory Usage</h3>
<p>By calling MemoryUsageSampler.startMemoryUsageSampling(sampleTime) memory usage will be sampled at the provided interval. Sampled data ill be aggregated at the interval set by perf.memory.sampleAggMillis system property. Data will be stored into a spf4j tsdb where data can be accessed via jmx or the sf4j ui.</p></div>
<div class="section">
<h3><a name="a5.9._Monitoring_File_Usage"></a>5.9. Monitoring File Usage</h3>
<p>By calling OpenFilesSampler.startFileUsageSampling(sampleTime, warnThreshold, errorThreshold), file usage will be sampled at the provided interval. This is usefull to see open files trend and detect file handle leaks, which will cause in general outages of your application. The warn and error threshold numbers will long details provided by lsof to help you troubleshoot what is going on. Sampled data will be aggregated at the interval set by perf.io.openFiles.sampleAggMillis system property. Data will be stored into a spf4j tsdb where data can be accessed via jmx or the sf4j ui.</p></div></div>
<div class="section">
<h2><a name="a6._High_Performance_Object_Pool"></a>6. High Performance Object Pool</h2>
<div class="section">
<h3><a name="a6.1._Why_another_object_pool_implementation.3F"></a>6.1. Why another object pool implementation?</h3>
<p>In my(I am not alone) view current available object pool implementations are less than perfect. Beside the scalability issues and bugs, I don&#x2019;t like the following implementation choices found in other implementations:</p>
<ul>

<li>

<ol style="list-style-type: decimal">

<li>Test on borrow is pointless, there is no guarantee that you will get a valid object even if you test on borrow. This encourages the developer to disregard handling of this case when it receives an invalid object. This practice also often is a performance killer.</li>
</ol>
</li>
<li>

<ol style="list-style-type: decimal">

<li>Indiscriminate test on return is not optimal either. Test on return should be done only in the case where there is a suspicion that the object is invalid, otherwise the performance impact will be too high to be acceptable in most cases. Pool client should be able to provide feedback on return for that case.</li>
</ol>
</li>
<li>

<ol style="list-style-type: decimal">

<li>NO exception swallowing. If a exception happens with the pooled objects the pool user will know about it and will have to handle it.</li>
</ol>
</li>
</ul>
<p>One of the most popular object pool implementations is apache commons-pool with dbcp-pool specialized in JDBC object based on it. A lot of people are unhappy with this implementation (including myself), so much that the apache tomcat developers wrote their own implementation. Here is a comparison of their implementation against dbcp pool:</p>
<p><a class="externalLink" href="http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html">http://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html</a></p>
<p>A performance comparison between dbcp, c3p0, and tomcat jdbc pool :</p>
<p><a class="externalLink" href="http://www.tomcatexpert.com/blog/2010/03/22/understanding-jdbc-pool-performance-improvements">http://www.tomcatexpert.com/blog/2010/03/22/understanding-jdbc-pool-performance-improvements</a></p>
<p>The goal of this implementation is to be more reliable and faster than any of the implementations out there.</p></div>
<div class="section">
<h3><a name="a6.2._Use_case"></a>6.2. Use case</h3>
<p>The classical use case for an object pool is to pool your jdbc connections or any type of network connection.</p></div>
<div class="section">
<h3><a name="a6.3._How_to_use_the_object_pool"></a>6.3. How to use the object pool</h3>
<p>Creating a pool is simple:</p>

<div>
<div>
<pre class="source">RecyclingSupplier&lt;ExpensiveTestObject&gt; pool = new RecyclingSupplierBuilder(10, new ExpensiveTestObjectFactory()).build();
</pre></div></div>

<p>at minimum you will need to provide the maximum size and the object factory. To do something with a object from a pool you will need to:</p>

<div>
<div>
<pre class="source">Template.doOnSupplied(new Handler&lt;PooledObject, SomeException&gt;() {
   @Override
   public void handle( PooledObject object, long deadline) throws SomeException {
   object.doStuff();
   }
}, pool, imediateRetries, maxBackoffDelay, timeout );
</pre></div></div>

<p>You can also use the get and recycle methods on the object pool to get and return an object to the pool.</p></div>
<div class="section">
<h3><a name="a6.4._How_does_the_pool_work.3F"></a>6.4. How does the pool work?</h3>
<p>The architecture above biases object to threads, so a thread will most likely get the same object minimizing object contention (if pool size &gt;= thread nr which is the recommended sizing).</p>

<div>
<div>
<pre class="source">      [code context]  &lt;----&gt; [Thread Local Pool] &lt;----&gt; [Global Pool]                                                       
</pre></div></div>

<p>On the other hand this pool implementation will prefer to create a new connection instead of reusing a connection that has already has been used by another thread. This is alleviated by the maintenance process which can bring back unused local object to the global pool.</p></div></div>
<div class="section">
<h2><a name="a7_The_Execution_Context."></a>7 The Execution Context.</h2>
<p>When building systems often the need arises to have parameters that address system wide concerns passed across function invocation transparently. (ThreadLocals) Some examples in practice are JDBC transaction contexts(Spring) tracing information (Opentrace/Jaeger/&#x2026;). In spf4j the main use case for something like this arised for the propagation of deadlines, which are fundamental when coding distributed systems.</p>
<p>as such the ExecutionContext can be easilly created like:</p>

<div>
<div>
<pre class="source">try (ExecutionContext ctx = ExecutionContexts.start(&quot;operation_name&quot;, timeout, timeUnit)) {
  ....
}

</pre></div></div>

<p>the execution context can be retrieved with:</p>

<div>
<div>
<pre class="source">   ExecutionContext ctx = ExecutionContexts.current();
</pre></div></div>

<p>Execution contexts are transfered across Thread boundaries with: ContextPropagatingExecutorService (can wrap any executorservice) or you can create context transfering Callables and Runnables with ExecutorContexts utility methods.</p>
<p>Execution contexts implementations are cutomizable with the system property: spf4j.execContentFactoryClass where you can specify your custom ExecutionContextFactory implementation.</p></div>
<div class="section">
<h2><a name="a8._Retry.2Ffailure_handling_utilities."></a>8. Retry/failure handling utilities.</h2>
<p>Although there are other libraries that provide this functionality, I haven&#x2019;t found any that can do:</p>
<ul>

<li>1) No Exception lost + ability to propagate checked exceptions (Sync mode only).</li>
<li>2) Retry operation can be different from original operation. (redirect, fallback, etc&#x2026;)</li>
<li>3) The retry operation can be executed with delay which can be a function of the response or exception.</li>
<li>4) Timeouts are core functionality. (Support)</li>
<li>5) sync and async retry capabilities.</li>
<li>6) ability to propagate checked exceptions.</li>
</ul>
<p>Here is example:</p>

<div>
<div>
<pre class="source">        RetryPolicy.&lt;Response, ServerCall&gt;newBuilder()
           .withDeadlineSupplier((c) -&gt; c.getDeadlineNanos())
           .withDefaultThrowableRetryPredicate() // use known transient exceptions.
           .withResultPartialPredicate((resp, sc) -&gt; {
             switch (resp.getType()) {
               case CLIENT_ERROR:
                 return RetryDecision.abort();
               case REDIRECT:
                 return RetryDecision.retry(0, new ServerCall(sc.getServer(),
                         new Request((String) resp.getPayload(), sc.getRequest().getDeadlineMSEpoch())));
               case RETRY_LATER:
                 return RetryDecision.retry(
                         TimeUnit.NANOSECONDS.convert((Long) resp.getPayload() - System.currentTimeMillis(),
                                 TimeUnit.MILLISECONDS), sc);
               case TRANSIENT_ERROR:
                 return RetryDecision.retryDefault(sc);
               case ERROR:
                 return null;
               case OK:
                 return RetryDecision.abort();
               default:
                 throw new IllegalStateException(&quot;Unsupported &quot; + resp.getType());
             }
           }).withResultPartialPredicate((resp, sc)
           -&gt; (resp.getType() == Response.Type.ERROR)
           ? RetryDecision.retryDefault(sc)
           : RetryDecision.abort(), 3)
           .withExecutorService(es)
           .build().call(serverCall, IOException.class);
</pre></div></div>
</div>
<div class="section">
<h2><a name="a9._Other_utilities"></a>9. Other utilities</h2>
<p>Lifo Threadpool: org.spf4j.concurrent.LifoThreadPoolBuilder</p>
<p>Retry utility implementation: see org.spf4j.base.Callables and org.spf4j.concurrent.RetryExecutor</p>
<p>Union: see org.spf4j.base.Either</p>
<p>Unique ID and Scalable sequence generators: org.spf4j.concurrent.UIDgenerator and org.spf4j.concurrent.ScalableSequence</p>
<p>Csv: org.spf4j.io.Csv</p>
<p>IPC: org.spf4j.concurrent.FileBasedLock</p>
<p>Data Structures: org.spf4j.ds.RTree; org.spf4j.ds.Graph; org.spf4j.ds.UpdateablePriorityQueue</p>
<p>Process control: org.spf4j.base.Runtime</p>
<p>Object recyclers: org.spf4j.recyclable.impl.*</p>
<p>Concurrency: org.spf4j.io.PipedOutputStream</p>
<p>String performance utilities: org.spf4j.base.Strings</p>
<p>NIO TCP proxy server: org.spf4j.io.tcp.proxy.*</p>
<p>Distributed semaphore: org.spf4j.concurrent.jdbc.JdbcSemaphore</p></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2018
<a href="http://www.spf4j.org">SPF4J</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
