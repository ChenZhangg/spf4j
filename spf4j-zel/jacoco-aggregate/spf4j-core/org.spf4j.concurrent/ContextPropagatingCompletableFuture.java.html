<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ContextPropagatingCompletableFuture.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">spf4j-zel</a> &gt; <a href="../index.html" class="el_bundle">spf4j-core</a> &gt; <a href="index.source.html" class="el_package">org.spf4j.concurrent</a> &gt; <span class="el_source">ContextPropagatingCompletableFuture.java</span></div><h1>ContextPropagatingCompletableFuture.java</h1><pre class="source lang-java linenums">package org.spf4j.concurrent;

import com.google.common.annotations.Beta;
import java.lang.reflect.InvocationTargetException;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Executor;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;
import java.util.function.BiConsumer;
import java.util.function.BiFunction;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.function.Supplier;
import javax.annotation.Nullable;
import javax.annotation.ParametersAreNonnullByDefault;
import org.spf4j.base.ExecutionContext;
import org.spf4j.base.ExecutionContexts;
import org.spf4j.base.TimeSource;
import org.spf4j.base.Timing;
import org.spf4j.base.UncheckedTimeoutException;

/**
 * A Completable future that will wrap all Functions to properly propagate ExecutionContext.
 * see CompletableFuture javadoc for more detail.
 *
 * This works properly only in JDK 11.
 *
 * @author Zoltan Farkas
 */
@SuppressWarnings(&quot;checkstyle:DesignForExtension&quot;)
@Beta
@ParametersAreNonnullByDefault
public class ContextPropagatingCompletableFuture&lt;T&gt;
        extends InterruptibleCompletableFuture&lt;T&gt; {

  private final ExecutionContext parentContext;

  private final long deadlinenanos;

<span class="fc" id="L42">  public ContextPropagatingCompletableFuture(final ExecutionContext parentContext, final long deadlinenanos) {</span>
<span class="fc" id="L43">    this.parentContext = parentContext;</span>
<span class="fc" id="L44">    this.deadlinenanos = deadlinenanos;</span>
<span class="fc" id="L45">  }</span>



  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenApply(final Function&lt;? super T, ? extends U&gt; fn) {
<span class="nc" id="L51">    return super.thenApply(ExecutionContexts.propagatingFunction(fn, parentContext,</span>
            null, deadlinenanos));
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(final Function&lt;? super T, ? extends U&gt; fn) {
<span class="nc" id="L57">    return super.thenApplyAsync(ExecutionContexts.propagatingFunction(fn, parentContext,</span>
            null, deadlinenanos));
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(final Function&lt;? super T, ? extends U&gt; fn, final Executor executor) {
<span class="nc" id="L63">    return super.thenApplyAsync(ExecutionContexts.propagatingFunction(fn, parentContext,</span>
            null, deadlinenanos), executor);
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenAccept(final Consumer&lt;? super T&gt; action) {
<span class="nc" id="L69">    return super.thenAccept(ExecutionContexts.propagatingConsumer(action,</span>
            parentContext, null, deadlinenanos));
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenAcceptAsync(final Consumer&lt;? super T&gt; action) {
<span class="nc" id="L75">    return super.thenAcceptAsync(ExecutionContexts.propagatingConsumer(action,</span>
            parentContext, null, deadlinenanos));
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenAcceptAsync(final Consumer&lt;? super T&gt; action, final Executor executor) {
<span class="nc" id="L81">    return super.thenAcceptAsync(ExecutionContexts.propagatingConsumer(action,</span>
            parentContext, null, deadlinenanos), executor);
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenRun(final Runnable action) {
<span class="nc" id="L87">    return super.thenRun(ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenRunAsync(final Runnable action) {
<span class="nc" id="L92">    return super.thenRunAsync(</span>
<span class="nc" id="L93">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; thenRunAsync(final Runnable action, final Executor executor) {
<span class="nc" id="L98">    return super.thenRunAsync(</span>
<span class="nc" id="L99">                    ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public &lt;U, V&gt; CompletableFuture&lt;V&gt; thenCombine(final CompletionStage&lt;? extends U&gt; other,
          final BiFunction&lt;? super T, ? super U, ? extends V&gt; fn) {
<span class="nc" id="L105">    return super.thenCombine(other,</span>
<span class="nc" id="L106">            ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U, V&gt; CompletableFuture&lt;V&gt; thenCombineAsync(final CompletionStage&lt;? extends U&gt; other,
          final BiFunction&lt;? super T, ? super U, ? extends V&gt; fn) {
<span class="nc" id="L112">    return super.thenCombineAsync(other,</span>
<span class="nc" id="L113">            ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U, V&gt; CompletableFuture&lt;V&gt; thenCombineAsync(final CompletionStage&lt;? extends U&gt; other,
          final BiFunction&lt;? super T, ? super U, ? extends V&gt; fn, final Executor executor) {
<span class="nc" id="L119">    return super.thenCombineAsync(other,</span>
<span class="nc" id="L120">                    ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos),</span>
                    executor);
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBoth(final CompletionStage&lt;? extends U&gt; other,
          final BiConsumer&lt;? super T, ? super U&gt; action) {
<span class="nc" id="L127">    return super.thenAcceptBoth(other, ExecutionContexts.propagatingBiConsumer(action, parentContext,</span>
                    null, deadlinenanos));
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBothAsync(final CompletionStage&lt;? extends U&gt; other,
          final BiConsumer&lt;? super T, ? super U&gt; action) {
<span class="nc" id="L134">    return super.thenAcceptBothAsync(other,</span>
<span class="nc" id="L135">            ExecutionContexts.propagatingBiConsumer(action, parentContext,</span>
                    null, deadlinenanos));
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;Void&gt; thenAcceptBothAsync(final CompletionStage&lt;? extends U&gt; other,
          final BiConsumer&lt;? super T, ? super U&gt; action, final Executor executor) {
<span class="nc" id="L142">    return super.thenAcceptBothAsync(other,</span>
<span class="nc" id="L143">            ExecutionContexts.propagatingBiConsumer(action, parentContext,</span>
                    null, deadlinenanos), executor);
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterBoth(final CompletionStage&lt;?&gt; other, final Runnable action) {
<span class="nc" id="L149">    return super.runAfterBoth(other,</span>
<span class="nc" id="L150">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterBothAsync(final CompletionStage&lt;?&gt; other, final Runnable action) {
<span class="nc" id="L155">    return super.runAfterBothAsync(other, ExecutionContexts.propagatingRunnable(action, parentContext,</span>
            null, deadlinenanos));
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterBothAsync(final CompletionStage&lt;?&gt; other,
          final Runnable action, final Executor executor) {
<span class="nc" id="L162">    return super.runAfterBothAsync(other, ExecutionContexts.propagatingRunnable(action, parentContext,</span>
            null, deadlinenanos), executor);
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; applyToEither(final CompletionStage&lt;? extends T&gt; other,
          final Function&lt;? super T, U&gt; fn) {
<span class="nc" id="L169">    return super.applyToEither(other,</span>
<span class="nc" id="L170">                    ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; applyToEitherAsync(final CompletionStage&lt;? extends T&gt; other,
          final Function&lt;? super T, U&gt; fn) {
<span class="nc" id="L176">    return super.applyToEitherAsync(other,</span>
<span class="nc" id="L177">            ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; applyToEitherAsync(final CompletionStage&lt;? extends T&gt; other,
          final Function&lt;? super T, U&gt; fn, final Executor executor) {
<span class="nc" id="L183">    return super.applyToEitherAsync(other,</span>
<span class="nc" id="L184">            ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; acceptEither(final CompletionStage&lt;? extends T&gt; other,
          final Consumer&lt;? super T&gt; action) {
<span class="nc" id="L190">    return super.acceptEither(other,</span>
<span class="nc" id="L191">            ExecutionContexts.propagatingConsumer(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; acceptEitherAsync(final CompletionStage&lt;? extends T&gt; other,
          final Consumer&lt;? super T&gt; action) {
<span class="nc" id="L197">    return super.acceptEitherAsync(other,</span>
<span class="nc" id="L198">            ExecutionContexts.propagatingConsumer(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; acceptEitherAsync(final CompletionStage&lt;? extends T&gt; other,
          final Consumer&lt;? super T&gt; action, final Executor executor) {
<span class="nc" id="L204">    return super.acceptEitherAsync(other,</span>
<span class="nc" id="L205">            ExecutionContexts.propagatingConsumer(action, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterEither(final CompletionStage&lt;?&gt; other, final Runnable action) {
<span class="nc" id="L210">    return super.runAfterEither(other,</span>
<span class="nc" id="L211">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterEitherAsync(final CompletionStage&lt;?&gt; other, final Runnable action) {
<span class="nc" id="L216">    return super.runAfterEitherAsync(other,</span>
<span class="nc" id="L217">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;Void&gt; runAfterEitherAsync(final CompletionStage&lt;?&gt; other,
          final Runnable action, final Executor executor) {
<span class="nc" id="L223">    return super.runAfterEitherAsync(other,</span>
<span class="nc" id="L224">            ExecutionContexts.propagatingRunnable(action, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenCompose(final Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn) {
<span class="nc" id="L229">    return super.thenCompose(ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenComposeAsync(final Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn) {
<span class="nc" id="L234">    return super.thenComposeAsync(ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; thenComposeAsync(final Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn,
          final Executor executor) {
<span class="nc" id="L240">    return super.thenComposeAsync(</span>
<span class="nc" id="L241">            ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; exceptionally(final Function&lt;Throwable, ? extends T&gt; fn) {
<span class="nc" id="L246">    return super.exceptionally(ExecutionContexts.propagatingFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; whenComplete(final BiConsumer&lt;? super T, ? super Throwable&gt; action) {
<span class="fc" id="L251">    return super.whenComplete(ExecutionContexts.propagatingBiConsumer(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; whenCompleteAsync(final BiConsumer&lt;? super T, ? super Throwable&gt; action) {
<span class="nc" id="L256">    return super.whenCompleteAsync(</span>
<span class="nc" id="L257">            ExecutionContexts.propagatingBiConsumer(action, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; whenCompleteAsync(final BiConsumer&lt;? super T, ? super Throwable&gt; action,
          final Executor executor) {
<span class="nc" id="L263">    return super.whenCompleteAsync(</span>
<span class="nc" id="L264">            ExecutionContexts.propagatingBiConsumer(action, parentContext, null, deadlinenanos),</span>
            executor);
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; handle(final BiFunction&lt;? super T, Throwable, ? extends U&gt; fn) {
<span class="nc" id="L270">    return super.handle(ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; handleAsync(final BiFunction&lt;? super T, Throwable, ? extends U&gt; fn) {
<span class="nc" id="L275">    return super.handleAsync(</span>
<span class="nc" id="L276">            ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos));</span>
  }

  @Override
  public &lt;U&gt; CompletableFuture&lt;U&gt; handleAsync(final BiFunction&lt;? super T, Throwable, ? extends U&gt; fn,
          final Executor executor) {
<span class="nc" id="L282">    return super.handleAsync(</span>
<span class="nc" id="L283">            ExecutionContexts.propagatingBiFunction(fn, parentContext, null, deadlinenanos), executor);</span>
  }

  @Override
  public CompletableFuture&lt;T&gt; toCompletableFuture() {
<span class="nc" id="L288">    return this;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L293">    return &quot;ContextPropagatingCompletableFuture{&quot; + &quot;parentContext=&quot; + parentContext</span>
<span class="nc" id="L294">            + &quot;, deadlinenanos=&quot; + deadlinenanos + &quot;, super=&quot; + super.toString() +  '}';</span>
  }

  @Override
  @Nullable
  public T get() throws InterruptedException, ExecutionException {
    try {
<span class="fc" id="L301">      long timeout = deadlinenanos - TimeSource.nanoTime();</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">      if (timeout &lt; 0) {</span>
<span class="nc" id="L303">        throw new UncheckedTimeoutException(&quot;deadline exceeded &quot; + Timing.getCurrentTiming()</span>
<span class="nc" id="L304">                .fromNanoTimeToInstant(deadlinenanos));</span>
      }
<span class="fc" id="L306">      return super.get(timeout, TimeUnit.NANOSECONDS);</span>
<span class="nc" id="L307">    } catch (TimeoutException ex) {</span>
<span class="nc" id="L308">      throw new UncheckedTimeoutException(ex);</span>
    }
  }


  /**
   * JDK 11.
   */
  public CompletableFuture&lt;T&gt; completeAsync(final Supplier&lt;? extends T&gt; supplier) {
    try {
<span class="nc" id="L318">      return (CompletableFuture)</span>
<span class="nc" id="L319">              this.getClass().getMethod(&quot;completeAsync&quot;, new Class[] {Supplier.class})</span>
<span class="nc" id="L320">                .invoke(this, ExecutionContexts.propagatingSupplier(supplier, parentContext, null, deadlinenanos));</span>
<span class="nc" id="L321">    } catch (NoSuchMethodException | SecurityException | IllegalAccessException | InvocationTargetException ex) {</span>
<span class="nc" id="L322">      throw new UnsupportedOperationException(&quot;Supported only on JDK 11&quot;, ex);</span>
    }
  }

  /**
   * JDK 11.
   */
  public CompletableFuture&lt;T&gt; completeAsync(final Supplier&lt;? extends T&gt; supplier, final Executor executor) {
    try {
<span class="nc" id="L331">      return (CompletableFuture)</span>
<span class="nc" id="L332">              this.getClass().getMethod(&quot;completeAsync&quot;, new Class[] {Supplier.class, Executor.class})</span>
<span class="nc" id="L333">                      .invoke(this,</span>
<span class="nc" id="L334">                              ExecutionContexts.propagatingSupplier(supplier, parentContext, null, deadlinenanos),</span>
                              executor);
<span class="nc" id="L336">    } catch (NoSuchMethodException | SecurityException | IllegalAccessException | InvocationTargetException ex) {</span>
<span class="nc" id="L337">      throw new UnsupportedOperationException(&quot;Supported only on JDK 11&quot;, ex);</span>
    }
  }

  /**
   * JDK 11!
   */
  public &lt;U&gt; CompletableFuture&lt;U&gt; newIncompleteFuture() {
<span class="nc" id="L345">    return new ContextPropagatingCompletableFuture&lt;&gt;(parentContext, deadlinenanos);</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(final Supplier&lt;U&gt; f) {
<span class="nc" id="L349">    return supplyAsync(f, DefaultExecutor.INSTANCE);</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(final Supplier&lt;U&gt; f, final Executor e) {
<span class="fc" id="L353">    ExecutionContext current = ExecutionContexts.current();</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">    if (current == null) {</span>
<span class="nc" id="L355">      return CompletableFuture.supplyAsync(f, e);</span>
    }
<span class="fc" id="L357">    return supplyAsync(f, current, e, current.getDeadlineNanos());</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(
          final Supplier&lt;U&gt; f, final Executor e, final long deadlineNanos) {
<span class="nc" id="L362">    ExecutionContext current = ExecutionContexts.current();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">    if (current == null) {</span>
<span class="nc" id="L364">      return CompletableFuture.supplyAsync(f, e);</span>
    }
<span class="nc" id="L366">    return supplyAsync(f, current, e, deadlineNanos);</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(final Supplier&lt;U&gt; f,
          final ExecutionContext current,
          final Executor e, final long deadlineNanos) {
<span class="fc" id="L372">    long ctxDeadlineNanos = current.getDeadlineNanos();</span>
<span class="fc" id="L373">    long currentTime = TimeSource.nanoTime();</span>
    long effectiveDeadlineNanos;
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">    if ((ctxDeadlineNanos - currentTime) &gt; (deadlineNanos - currentTime)) {</span>
<span class="nc" id="L376">      effectiveDeadlineNanos = deadlineNanos;</span>
    } else {
<span class="fc" id="L378">      effectiveDeadlineNanos = ctxDeadlineNanos;</span>
    }
<span class="fc" id="L380">    ContextPropagatingCompletableFuture&lt;U&gt; d</span>
            = new ContextPropagatingCompletableFuture&lt;U&gt;(current, effectiveDeadlineNanos);
<span class="fc" id="L382">    e.execute(() -&gt; {</span>
      try {
        U r;
<span class="fc" id="L385">        try (ExecutionContext ec = ExecutionContexts.start(f.toString(), current,</span>
                currentTime, effectiveDeadlineNanos)) {
<span class="fc" id="L387">          r = f.get();</span>
        }
<span class="fc" id="L389">        d.complete(r);</span>
<span class="nc" id="L390">      } catch (Throwable t) {</span>
<span class="nc" id="L391">        d.completeExceptionally(t);</span>
<span class="fc" id="L392">      }</span>
<span class="fc" id="L393">    });</span>
<span class="fc" id="L394">    return d;</span>
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; completedFuture(final U value) {
<span class="nc" id="L398">    ExecutionContext current = ExecutionContexts.current();</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">    if (current == null) {</span>
<span class="nc" id="L400">      return CompletableFuture.completedFuture(value);</span>
    } else {
<span class="nc" id="L402">      return completedFuture(current, current.getDeadlineNanos(), value);</span>
    }
  }

  public static &lt;U&gt; CompletableFuture&lt;U&gt; completedFuture(
          final ExecutionContext parentContext, final long deadlinenanos, final U value) {
<span class="nc" id="L408">    ContextPropagatingCompletableFuture&lt;U&gt; r = new ContextPropagatingCompletableFuture&lt;U&gt;(parentContext, deadlinenanos);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">    if (!r.complete(value)) {</span>
<span class="nc" id="L410">      throw new IllegalStateException(&quot;Cannot be already completed &quot; + r);</span>
    }
<span class="nc" id="L412">    return r;</span>
  }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>