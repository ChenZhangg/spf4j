<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>StackDumpJInternalFrame.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">spf4j-jacoco-aggregate</a> &gt; <a href="../index.html" class="el_bundle">spf4j-ui</a> &gt; <a href="index.source.html" class="el_package">org.spf4j.ui</a> &gt; <span class="el_source">StackDumpJInternalFrame.java</span></div><h1>StackDumpJInternalFrame.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2001-2017, Zoltan Farkas All Rights Reserved.
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 *
 * Additionally licensed with:
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.spf4j.ui;
//CHECKSTYLE:OFF

import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.awt.event.ItemEvent;
import java.io.BufferedWriter;
import java.io.File;
import java.io.IOException;
import java.io.UncheckedIOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.util.LinkedList;
import javax.swing.JFileChooser;
import javax.swing.filechooser.FileFilter;
import org.spf4j.base.Methods;
import org.spf4j.ssdump2.Converter;
import org.spf4j.stackmonitor.SampleNode;

/**
 * will need to add some standard filtering:
 *
 * Pair.of(sun.misc.Unsafe.class.getName(), &quot;park&quot;)); Pair.of(java.lang.Object.class.getName(), &quot;wait&quot;));
 * Pair.of(java.lang.Thread.class.getName(), &quot;sleep&quot;)); Pair.of(&quot;java.net.PlainSocketImpl&quot;, &quot;socketAccept&quot;));
 * Pair.of(&quot;java.net.PlainSocketImpl&quot;, &quot;socketConnect&quot;));
 *
 * @author zoly
 */
@SuppressFBWarnings({&quot;FCBL_FIELD_COULD_BE_LOCAL&quot;, &quot;SE_BAD_FIELD&quot;})
public class StackDumpJInternalFrame extends javax.swing.JInternalFrame {

  private SampleNode samples;

  /**
   * Creates new form StackDumpJInternalFrame
   */
  public StackDumpJInternalFrame(final SampleNode samples,
          final String title, final boolean isgraph) {
<span class="nc" id="L69">    super(title);</span>
<span class="nc" id="L70">    setName(title);</span>
<span class="nc" id="L71">    initComponents();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">    if (samples == null) {</span>
<span class="nc" id="L73">      this.samples = SampleNode.createSampleNode(</span>
              new StackTraceElement[]{new StackTraceElement(&quot;NO SAMPLES&quot;, &quot;&quot;, &quot;&quot;, -1)});
    } else {
<span class="nc" id="L76">      this.samples = samples;</span>
    }
<span class="nc" id="L78">    setViewType(isgraph);</span>
<span class="nc" id="L79">    ssScrollPanel.setVisible(true);</span>
<span class="nc" id="L80">    pack();</span>
<span class="nc" id="L81">  }</span>

  private void setViewType(final boolean isgraph) {
<span class="nc" id="L84">    StackPanelBase view = (StackPanelBase) ssScrollPanel.getViewport().getView();</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">    if (isgraph) {</span>
<span class="nc" id="L86">      graphToggle.setSelected(true);</span>
      //ssScrollPanel.setViewportView(new ZStackPanel(this.samples));
<span class="nc bnc" id="L88" title="All 2 branches missed.">      if (view != null) {</span>
<span class="nc" id="L89">        ssScrollPanel.setViewportView(new HotFlameStackPanel(view.getMethod(), view.getSamples(), view.getHistory()));</span>
      } else {
<span class="nc" id="L91">        ssScrollPanel.setViewportView(new HotFlameStackPanel(Methods.ROOT, this.samples, new LinkedList&lt;&gt;()));</span>
      }
    } else {
<span class="nc" id="L94">      graphToggle.setSelected(false);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">      if (view != null) {</span>
<span class="nc" id="L96">        ssScrollPanel.setViewportView(new FlameStackPanel(view.getMethod(), view.getSamples(), view.getHistory()));</span>
      } else {
<span class="nc" id="L98">        ssScrollPanel.setViewportView(new FlameStackPanel(Methods.ROOT, this.samples, new LinkedList&lt;&gt;()));</span>
      }
    }
<span class="nc" id="L101">  }</span>

  /**
   * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The
   * content of this method is always regenerated by the Form Editor.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  @SuppressFBWarnings
  // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;Generated Code&quot;&gt;//GEN-BEGIN:initComponents
  private void initComponents() {

<span class="nc" id="L112">    ssScrollPanel = new javax.swing.JScrollPane();</span>
<span class="nc" id="L113">    samplesVisualizerToolbar = new javax.swing.JToolBar();</span>
<span class="nc" id="L114">    graphToggle = new javax.swing.JToggleButton();</span>
<span class="nc" id="L115">    exportButton = new javax.swing.JButton();</span>

<span class="nc" id="L117">    setClosable(true);</span>
<span class="nc" id="L118">    setIconifiable(true);</span>
<span class="nc" id="L119">    setMaximizable(true);</span>
<span class="nc" id="L120">    setResizable(true);</span>

<span class="nc" id="L122">    ssScrollPanel.setAutoscrolls(true);</span>

<span class="nc" id="L124">    samplesVisualizerToolbar.setRollover(true);</span>

<span class="nc" id="L126">    graphToggle.setText(&quot;graph&quot;);</span>
<span class="nc" id="L127">    graphToggle.setFocusable(false);</span>
<span class="nc" id="L128">    graphToggle.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);</span>
<span class="nc" id="L129">    graphToggle.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);</span>
<span class="nc" id="L130">    graphToggle.addItemListener(new java.awt.event.ItemListener() {</span>
      public void itemStateChanged(java.awt.event.ItemEvent evt) {
<span class="nc" id="L132">        graphToggleItemStateChanged(evt);</span>
<span class="nc" id="L133">      }</span>
    });
<span class="nc" id="L135">    samplesVisualizerToolbar.add(graphToggle);</span>

<span class="nc" id="L137">    exportButton.setText(&quot;export&quot;);</span>
<span class="nc" id="L138">    exportButton.setFocusable(false);</span>
<span class="nc" id="L139">    exportButton.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);</span>
<span class="nc" id="L140">    exportButton.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);</span>
<span class="nc" id="L141">    exportButton.addActionListener(new java.awt.event.ActionListener() {</span>
      public void actionPerformed(java.awt.event.ActionEvent evt) {
<span class="nc" id="L143">        exportButtonActionPerformed(evt);</span>
<span class="nc" id="L144">      }</span>
    });
<span class="nc" id="L146">    samplesVisualizerToolbar.add(exportButton);</span>

<span class="nc" id="L148">    org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(getContentPane());</span>
<span class="nc" id="L149">    getContentPane().setLayout(layout);</span>
<span class="nc" id="L150">    layout.setHorizontalGroup(</span>
<span class="nc" id="L151">      layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)</span>
<span class="nc" id="L152">      .add(ssScrollPanel, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 412, Short.MAX_VALUE)</span>
<span class="nc" id="L153">      .add(samplesVisualizerToolbar, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)</span>
    );
<span class="nc" id="L155">    layout.setVerticalGroup(</span>
<span class="nc" id="L156">      layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)</span>
<span class="nc" id="L157">      .add(org.jdesktop.layout.GroupLayout.TRAILING, layout.createSequentialGroup()</span>
<span class="nc" id="L158">        .add(samplesVisualizerToolbar, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 25, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)</span>
<span class="nc" id="L159">        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)</span>
<span class="nc" id="L160">        .add(ssScrollPanel, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 339, Short.MAX_VALUE))</span>
    );

<span class="nc" id="L163">    pack();</span>
<span class="nc" id="L164">  }// &lt;/editor-fold&gt;//GEN-END:initComponents</span>

  private void graphToggleItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_graphToggleItemStateChanged
<span class="nc bnc" id="L167" title="All 2 branches missed.">    setViewType(evt.getStateChange() == ItemEvent.SELECTED);</span>
<span class="nc" id="L168">  }//GEN-LAST:event_graphToggleItemStateChanged</span>

  @SuppressFBWarnings({ &quot;PATH_TRAVERSAL_IN&quot;, &quot;RCN_REDUNDANT_NULLCHECK_OF_NONNULL_VALUE&quot;, &quot;UP_UNUSED_PARAMETER&quot; })
  // this is a local app, FB sees problems with Try -&gt; {} genereted code......
  private void exportButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_exportButtonActionPerformed
<span class="nc" id="L173">    JFileChooser fc = new JFileChooser();</span>
<span class="nc" id="L174">    FileFilter[] xFF = fc.getChoosableFileFilters();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">    for (FileFilter ff : xFF) {</span>
<span class="nc" id="L176">      fc.removeChoosableFileFilter(ff);</span>
    }
<span class="nc" id="L178">    fc.addChoosableFileFilter(Spf4jFileFilter.D3_JSON);</span>
<span class="nc" id="L179">    fc.addChoosableFileFilter(Spf4jFileFilter.SPF4J_JSON);</span>
<span class="nc" id="L180">    fc.addChoosableFileFilter(Spf4jFileFilter.SSDUMP2);</span>
<span class="nc" id="L181">    fc.addChoosableFileFilter(Spf4jFileFilter.SSDUMP2_GZ);</span>
<span class="nc" id="L182">    fc.setFileFilter(Spf4jFileFilter.D3_JSON);</span>
<span class="nc" id="L183">    int retrival = fc.showSaveDialog(null);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">    if (retrival == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L185">      File selectedFile = fc.getSelectedFile();</span>
<span class="nc" id="L186">      FileFilter fileFilter = fc.getFileFilter();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">      if (!(fileFilter instanceof Spf4jFileFilter)) {</span>
<span class="nc" id="L188">        throw new IllegalArgumentException(&quot;Invalid file type selected &quot; + fileFilter);</span>
      }
<span class="nc" id="L190">      String suffix = ((Spf4jFileFilter) fileFilter).getSuffix();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">      if (!selectedFile.getName().endsWith(suffix)) {</span>
<span class="nc" id="L192">        selectedFile = new File(selectedFile.getParentFile(), selectedFile.getName() + suffix);</span>
      }
<span class="nc bnc" id="L194" title="All 2 branches missed.">      if (Spf4jFileFilter.D3_JSON.accept(selectedFile)) { // D3 format.</span>
<span class="nc" id="L195">        try (BufferedWriter wr = Files.newBufferedWriter(selectedFile.toPath(), StandardCharsets.UTF_8)) {</span>
<span class="nc" id="L196">          samples.writeD3JsonTo(wr);</span>
<span class="nc" id="L197">        } catch (IOException ex) {</span>
<span class="nc" id="L198">          throw new UncheckedIOException(ex);</span>
<span class="nc" id="L199">        }</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">      } else if (Spf4jFileFilter.SPF4J_JSON.accept(selectedFile)) {</span>
<span class="nc" id="L201">        try (BufferedWriter wr = Files.newBufferedWriter(selectedFile.toPath(), StandardCharsets.UTF_8)) {</span>
<span class="nc" id="L202">          samples.writeJsonTo(wr);</span>
<span class="nc" id="L203">        } catch (IOException ex) {</span>
<span class="nc" id="L204">          throw new UncheckedIOException(ex);</span>
<span class="nc" id="L205">        }</span>
<span class="nc bnc" id="L206" title="All 4 branches missed.">      } else if (Spf4jFileFilter.SSDUMP2.accept(selectedFile) || Spf4jFileFilter.SSDUMP2_GZ.accept(selectedFile)) {</span>
        try {
<span class="nc" id="L208">          Converter.save(selectedFile, samples);</span>
<span class="nc" id="L209">        } catch (IOException ex) {</span>
<span class="nc" id="L210">          throw new UncheckedIOException(ex);</span>
<span class="nc" id="L211">        }</span>
      } else {
<span class="nc" id="L213">        throw new IllegalArgumentException(&quot;No ecognized extension for file &quot; + selectedFile);</span>
      }
    }
<span class="nc" id="L216">  }//GEN-LAST:event_exportButtonActionPerformed</span>

  // Variables declaration - do not modify//GEN-BEGIN:variables
  private javax.swing.JButton exportButton;
  private javax.swing.JToggleButton graphToggle;
  private javax.swing.JToolBar samplesVisualizerToolbar;
  private javax.swing.JScrollPane ssScrollPanel;
  // End of variables declaration//GEN-END:variables
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>